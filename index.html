<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stan reReCAPTCHA v4</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        .ease-spring { transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* --- ANIMATIONS --- */
        @keyframes cry { 0% { top: 65px; } 100% { top: 80px; } }
        .animate-cry { animation: cry 1s infinite alternate; }
        
        @keyframes dance { 
            0%, 100% { transform: translateY(0); } 
            25% { transform: translateY(-10px) rotate(-5deg); } 
            75% { transform: translateY(-5px) rotate(5deg); } 
        }
        .animate-dance { animation: dance 0.5s infinite; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s infinite; }

        @keyframes rps-shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-40deg); }
            75% { transform: rotate(10deg); }
            100% { transform: rotate(0deg); }
        }
        .animate-rps { animation: rps-shake 0.5s infinite; }

        @keyframes backflip {
            0% { transform: rotate(0deg) translateY(0); }
            40% { transform: rotate(-180deg) translateY(-60px); }
            80% { transform: rotate(-360deg) translateY(0); }
            100% { transform: rotate(-360deg) translateY(0); }
        }
        .animate-backflip { animation: backflip 1s ease-in-out; }

        @keyframes zzz-float {
            0% { transform: translate(0, 0) scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(10px, -30px) scale(1.2); opacity: 0; }
        }
        .zzz-symbol { animation: zzz-float 2.5s infinite ease-out; }

        @keyframes glitch-anim {
            0% { transform: translate(0); }
            2% { transform: translate(-2px, 2px); filter: hue-rotate(90deg); }
            4% { transform: translate(2px, -2px); filter: hue-rotate(-90deg); }
            6% { transform: translate(0); filter: none; }
            90% { transform: translate(0); }
            92% { transform: translate(1px, 1px); }
            94% { transform: translate(-1px, -1px); }
            100% { transform: translate(0); }
        }

        .particle { pointer-events: none; position: absolute; z-index: 50; }
        
        /* --- MODES --- */
        .matrix-mode {
            background-color: #000 !important;
            color: #00ff00 !important;
            font-family: 'Courier New', monospace !important;
            border-color: #00ff00 !important;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5) !important;
            animation: glitch-anim 3s infinite;
        }
        .matrix-mode input { background-color: #111 !important; color: #00ff00 !important; border-color: #00ff00 !important; }
        .matrix-mode button { background-color: #003300 !important; border: 1px solid #00ff00 !important; color: #00ff00 !important; }
        .matrix-mode button:hover { background-color: #00ff00 !important; color: #000 !important; }
        .matrix-mode .inventory-panel { background-color: #111 !important; color: #00ff00 !important; }
        
        /* Night Mode Background */
        .night-bg { background-color: #1a2533 !important; }
        .night-mode { background-color: rgba(255,255,255,0.9) !important; box-shadow: 0 0 30px rgba(255, 255, 255, 0.1) !important; }
        .night-bg #prompt-text { color: white !important; opacity: 0.8; }
        .night-bg #captcha-label { color: #8a9bbd !important; }

        .golden-skin .head, .golden-skin .ear, .golden-skin .neck, .golden-skin .hand, .golden-skin .nose {
            background: linear-gradient(135deg, #ffd700, #f1c40f, #ffed86) !important;
            box-shadow: inset 0 0 10px rgba(255, 255, 0, 0.5);
        }

        /* --- UI COMPONENTS --- */
        .item-card { transition: all 0.2s; }
        .item-card:hover { transform: translateY(-2px); }
        .item-card.locked { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        .item-card.locked .icon { filter: blur(5px); }
        .padlock-icon { transform: translateY(-15px); }
        .hidden { display: none !important; }

        .speech-bubble {
            position: absolute;
            top: -40px;
            right: -80px;
            background: white;
            border: 2px solid #333;
            border-radius: 15px;
            padding: 10px;
            font-size: 12px;
            font-weight: bold;
            width: 120px;
            text-align: center;
            z-index: 70;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid #333;
        }
        @keyframes pop-in { from { transform: scale(0); } to { transform: scale(1); } }

        .sleeping-pose {
            transform: rotate(90deg) translateX(30px);
            transform-origin: center center;
        }
        
        #draggable-food {
            cursor: grab;
            transition: transform 0.1s;
            touch-action: none;
        }
        #draggable-food:active {
            cursor: grabbing;
            transform: scale(1.1);
        }
    </style>
</head>
<body id="body" class="min-h-screen flex items-center justify-center font-sans selection:bg-[#5dade2] selection:text-white transition-colors duration-1000 bg-[#f0f2f5]">

    <div id="matrix-overlay" class="fixed inset-0 pointer-events-none opacity-20 z-0 overflow-hidden text-[#00ff00] font-mono text-xs break-all leading-3 hidden"></div>
    <div id="particle-container" class="fixed inset-0 pointer-events-none z-50 overflow-hidden"></div>
    
    <!-- DEV TOOLS -->
    <div class="fixed top-4 right-4 z-[200] flex flex-col items-end gap-2">
        <button id="dev-toggle" class="bg-gray-800 text-white text-[10px] px-3 py-1 rounded opacity-50 hover:opacity-100 shadow-md font-mono">Dev Tools</button>
        <div id="dev-panel" class="hidden bg-white p-2 rounded shadow-lg flex flex-col gap-2 w-32 border border-gray-200">
            <button id="dev-sleep" class="text-xs bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded text-left">Force Sleep</button>
            <button id="dev-wake" class="text-xs bg-green-100 hover:bg-green-200 px-2 py-1 rounded text-left">Force Wake</button>
            <button id="dev-hunger" class="text-xs bg-orange-100 hover:bg-orange-200 px-2 py-1 rounded text-left">Trigger Hunger</button>
            <button id="dev-bored" class="text-xs bg-purple-100 hover:bg-purple-200 px-2 py-1 rounded text-left">Trigger Boredom</button>
            <button id="dev-reset-daily" class="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-left">Reset Daily Cap</button>
        </div>
    </div>

    <div id="container" class="relative p-10 rounded-[20px] shadow-[0_10px_25px_rgba(0,0,0,0.1)] flex flex-col items-center w-[450px] transition-all duration-300 z-10 overflow-visible bg-white">
        
        <!-- Inventory Button -->
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2">
            <!-- Draggable Food (Visible when hungry) -->
            <div id="draggable-food" class="text-2xl hidden select-none z-50" draggable="false" title="Feed Stan">üç´</div>
            
            <button id="inventory-btn" class="p-2 rounded-full shadow-sm transition-all hover:scale-105 active:scale-95 bg-gray-100 text-gray-600 hover:bg-gray-200" title="Inventory">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
            </button>
        </div>

        <!-- Inventory Panel -->
        <div id="inventory-panel" class="inventory-panel absolute inset-0 bg-white/95 backdrop-blur-sm z-[100] transition-all duration-300 ease-spring flex flex-col p-6 translate-y-full opacity-0 pointer-events-none rounded-[20px]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold font-montserrat">Inventory</h2>
                <button id="close-inventory-btn" class="text-gray-500 hover:text-black">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="inventory-grid" class="grid grid-cols-2 gap-3 overflow-y-auto"></div>
        </div>

        <!-- Friendship Meter -->
        <div class="w-full mb-6 mt-2 relative z-10">
            <div class="flex justify-between text-xs font-bold uppercase tracking-widest mb-1 opacity-70">
                <span>Friendship</span>
                <span id="friendship-text">10%</span>
            </div>
            <div id="friendship-bg" class="w-full h-3 rounded-full overflow-hidden bg-gray-200">
                <div id="friendship-bar" class="h-full transition-all duration-500 ease-out" style="width: 10%; background-color: #e74c3c;"></div>
            </div>
        </div>

        <!-- STAN -->
        <div id="stan" class="relative w-[140px] h-[220px] mb-2 transition-all duration-300 idle">
            
            <!-- Needs Speech Bubble -->
            <div id="speech-bubble" class="speech-bubble hidden">I'm hungry!</div>

            <!-- Sleeping Zzz -->
            <!-- Accessories -->
            <div id="acc-hat" class="absolute -top-[40px] left-1/2 -translate-x-1/2 z-[60] hidden">
                <div class="relative w-0 h-0 border-l-[24px] border-l-transparent border-r-[24px] border-r-transparent border-b-[60px] border-b-[#3498db]">
                    <div class="absolute top-[20px] -left-[5px] w-2 h-2 bg-yellow-400 rounded-full opacity-90"></div>
                    <div class="absolute top-[35px] left-[2px] w-2 h-2 bg-red-400 rounded-full opacity-90"></div>
                    <div class="absolute top-[10px] -left-[2px] w-2 h-2 bg-green-400 rounded-full opacity-90"></div>
                    <div class="absolute top-[40px] -left-[12px] w-2 h-2 bg-purple-400 rounded-full opacity-90"></div>
                </div>
                <div class="absolute -top-[12px] left-1/2 -translate-x-1/2 w-[12px] h-[12px] bg-[#e74c3c] rounded-full"></div>
            </div>

            <div id="acc-tophat" class="absolute -top-[40px] left-1/2 -translate-x-1/2 z-[60] hidden">
                <div class="w-[50px] h-[50px] bg-[#111] mx-auto rounded-t-sm"></div>
                <div class="w-[70px] h-[10px] bg-[#111] -mt-1 rounded-sm"></div>
            </div>

            <!-- Redesigned Crown -->
            <div id="acc-crown" class="absolute top-[-30px] left-1/2 -translate-x-1/2 z-[60] hidden">
                <div class="flex">
                    <div class="w-0 h-0 border-l-[8px] border-r-[8px] border-b-[19px] border-l-transparent border-r-transparent border-b-yellow-400"></div>
                    <div class="w-0 h-0 border-l-[8px] border-r-[8px] border-b-[19px] border-l-transparent border-r-transparent border-b-yellow-400"></div>
                    <div class="w-0 h-0 border-l-[8px] border-r-[8px] border-b-[19px] border-l-transparent border-r-transparent border-b-yellow-400"></div>
                </div>
                <div class="w-full h-[26px] bg-yellow-400"></div>
            </div>
            
            <!-- Nightcap -->
            <div id="acc-nightcap" class="absolute top-[-25px] left-1/2 -translate-x-1/2 z-[60] hidden">
                 <div class="relative">
                    <div class="w-0 h-0 border-l-[25px] border-l-transparent border-r-[25px] border-r-transparent border-b-[60px] border-b-[#87ceeb] transform rotate-12 origin-bottom"></div>
                    <div class="absolute -top-1 -right-8 w-6 h-6 bg-white rounded-full"></div>
                 </div>
            </div>

            <div id="acc-ears" class="hidden">
                <div class="absolute -top-[5px] left-[15px] w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-b-[30px] border-b-[#333] transform -rotate-[40deg] z-[2]">
                    <div class="absolute top-[12px] -left-[5px] w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-b-[10px] border-b-pink-400"></div>
                </div>
                <div class="absolute -top-[5px] right-[15px] w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-b-[30px] border-b-[#333] transform rotate-[40deg] z-[2]">
                    <div class="absolute top-[12px] -left-[5px] w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-b-[10px] border-b-pink-400"></div>
                </div>
            </div>

            <!-- Body Parts -->
            <!-- Hair moved to Z-22 to be above Head(20) but below Hats(60) -->
            <div id="stan-hair" class="absolute -top-[15px] left-1/2 -translate-x-1/2 w-[20px] h-[25px] bg-[#333] rounded-t-[50%] z-[22] before:absolute before:bottom-0 before:-left-[5px] before:w-[10px] before:h-[10px] before:bg-[#333] before:rounded-full"></div>

            <div id="eyebrow-left" class="absolute top-[28px] left-[36px] w-[25px] h-[5px] bg-[#333] z-[4] rounded-full transition-transform duration-300"></div>
            <div id="eyebrow-right" class="absolute top-[28px] right-[36px] w-[25px] h-[5px] bg-[#333] z-[4] rounded-full transition-transform duration-300"></div>

            <!-- Sunglasses - Increased Z-Index to sit above Head (20) -->
            <div id="stan-sunglasses" class="absolute top-[35px] left-1/2 -translate-x-1/2 w-[80px] h-[35px] z-[25] flex justify-center">
                <div class="w-[40px] h-full border-[5px] border-black border-r-[2.5px] bg-transparent rounded-b-[12px]"></div>
                <div class="w-[40px] h-full border-[5px] border-black border-l-[2.5px] bg-transparent rounded-b-[12px]"></div>
                <div class="absolute top-0 left-0 w-full h-[5px] bg-black"></div>
            </div>

            <div class="ear absolute top-[50px] w-[20px] h-[25px] bg-[#eebb99] rounded-full z-[1] left-[10px]"></div>
            <div class="ear absolute top-[50px] w-[20px] h-[25px] bg-[#eebb99] rounded-full z-[1] right-[10px]"></div>

            <!-- HEAD: Increased Z-Index to 20 to sit above suit -->
            <div class="head relative w-[100px] h-[110px] bg-[#eebb99] rounded-[50px_50px_20px_20px] mx-auto z-[20]">
                <!-- Sweat Drops -->
                <div id="sweat-1" class="absolute top-[10px] right-[15px] w-[6px] h-[8px] bg-blue-300 rounded-full opacity-0 z-50"></div>
                <div id="sweat-2" class="absolute top-[20px] left-[10px] w-[5px] h-[7px] bg-blue-300 rounded-full opacity-0 z-50" style="animation-delay: 0.5s;"></div>

                <div id="eye-left" class="absolute top-[40px] left-[19px] w-[28px] h-[22px] bg-white rounded-b-[15px] z-[4] overflow-hidden flex justify-center items-center">
                    <div id="pupil-left" class="w-[10px] h-[10px] bg-black rounded-full transition-transform duration-300 translate-y-[-2px]"></div>
                </div>
                <div id="eye-right" class="absolute top-[40px] right-[19px] w-[28px] h-[22px] bg-white rounded-b-[15px] z-[4] overflow-hidden flex justify-center items-center">
                    <div id="pupil-right" class="w-[10px] h-[10px] bg-black rounded-full transition-transform duration-300 translate-y-[-2px]"></div>
                </div>

                <div id="stan-nose" class="nose absolute top-[75px] left-1/2 -translate-x-1/2 w-[12px] h-[12px] bg-[#daa07e] rounded-full z-[4]"></div>

                <div id="acc-nose" class="absolute top-[72px] left-1/2 -translate-x-1/2 w-[18px] h-[18px] bg-red-500 rounded-full z-[5] border border-red-700 shadow-sm hidden">
                    <div class="absolute top-1 left-1 w-[6px] h-[4px] bg-white rounded-full opacity-50"></div>
                </div>

                <!-- Monocle - Centered over right eye (51px, 33px) -> top 36, right 18 -->
                <div id="acc-monocle" class="absolute top-[36px] right-[18px] w-[30px] h-[30px] rounded-full border-2 border-yellow-600 z-[50] bg-blue-100/30 hidden">
                    <div class="absolute top-[24px] right-0 w-[2px] h-[18px] bg-yellow-600 rotate-12"></div>
                </div>
                
                <div id="stan-mouth" class="absolute left-1/2 -translate-x-1/2 transition-all duration-300 z-[3] h-[4px] bg-[#333] rounded-[2px] bottom-[18px] w-[30px]"></div>

                <div id="tear-left" class="absolute top-[70px] left-[25px] w-[4px] bg-[#5dade2] rounded-full transition-all duration-700 ease-in h-0 opacity-0"></div>
                <div id="tear-right" class="absolute top-[70px] right-[25px] w-[4px] bg-[#5dade2] rounded-full transition-all duration-700 ease-in h-0 opacity-0"></div>
            </div>

            <div class="relative w-[100px] h-[70px] bg-black -mt-[10px] mx-auto rounded-[10px_10px_0_0] z-[3]">
                <div class="neck absolute -top-[5px] left-1/2 -translate-x-1/2 w-[30px] h-[10px] bg-[#eebb99] z-[4]"></div>
                
                <div id="acc-suit" class="absolute inset-0 z-[5] hidden">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[20px] border-r-[20px] border-t-[40px] border-l-transparent border-r-transparent border-t-white"></div>
                    <!-- Tie moved up to -5px -->
                    <div class="absolute top-[-5px] left-1/2 -translate-x-1/2 w-[6px] h-[40px] bg-red-700 rounded-b"></div>
                </div>

                <div id="acc-bowtie" class="absolute top-[10px] left-1/2 -translate-x-1/2 z-[50] hidden">
                    <div class="flex items-center">
                        <div class="w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-red-600 border-b-[8px] border-b-transparent"></div>
                        <div class="w-3 h-3 bg-red-600 rounded-full -mx-1 relative z-10"></div>
                        <div class="w-0 h-0 border-t-[8px] border-t-transparent border-r-[12px] border-r-red-600 border-b-[5px] border-b-transparent"></div>
                    </div>
                </div>

                <div id="stan-arm" class="absolute top-[5px] -right-[15px] w-[25px] h-[80px] bg-black rounded-[10px] origin-top-center transition-all duration-500 ease-spring opacity-0 rotate-0">
                    <div class="hand absolute -bottom-[10px] left-0 w-[25px] h-[25px] bg-[#eebb99] rounded-full">
                        <div id="hand-item-wrapper" class="absolute -top-[40px] -left-[10px] w-[40px] h-[40px] transition-all duration-300 delay-200 opacity-0 scale-0 rotate-[20deg]">
                            <div id="icon-happy" class="hidden">
                                <svg viewBox="0 0 512 512" class="w-full h-full fill-[#2ecc71] drop-shadow-sm"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></svg>
                            </div>
                            <div id="icon-sad" class="hidden">
                                <svg viewBox="0 0 512 512" class="w-full h-full fill-[#e74c3c] drop-shadow-sm"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM175 175c9.4-9.4 24.6-9.4 33.9 0l47 47 47-47c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-47 47 47 47c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-47-47-47 47c-9.4-9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l47-47-47-47c-9.4-9.4-9.4-24.6 0-33.9z"/></svg>
                            </div>
                            <div id="icon-confused" class="hidden">
                                <svg viewBox="0 0 512 512" class="w-full h-full fill-[#95a5a6] drop-shadow-sm">
                                    <circle cx="256" cy="256" r="256" fill="#95a5a6"/>
                                    <path d="M241 128h30c33.1 0 60 26.9 60 60 0 18.2-8.3 34.5-21.3 45.4-12.3 10.3-19.7 25.8-19.7 42.6v10h-48v-14c0-29.9 13.6-56.7 35.1-73.6 5-3.9 8.2-10 8.2-16.7 0-12.1-9.9-22-22-22h-22c-12.1 0-22 9.9-22 22v14h-48v-18c0-33.1 26.9-60 60-60zm16 256c13.3 0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24z" fill="white" transform="translate(13, 20) scale(0.9)"/>
                                </svg>
                            </div>
                            <!-- Minigame Icons -->
                            <div id="icon-rock" class="hidden text-3xl">ü™®</div>
                            <div id="icon-paper" class="hidden text-3xl">üìÑ</div>
                            <div id="icon-scissors" class="hidden text-3xl">‚úÇÔ∏è</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pants - Added ID for coloring -->
            <div id="stan-pants" class="w-[100px] h-[40px] bg-[#2980b9] mx-auto rounded-[0_0_20px_20px] z-[2]">
                <div class="w-full h-[8px] bg-[#95a5a6]"></div>
            </div>

        </div>

        <!-- Zzz Particles -->
        <div id="zzz-container" class="absolute top-[160px] right-[100px] hidden z-[80]">
            <div class="zzz-symbol text-blue-400 font-bold text-xl absolute" style="animation-delay: 0s">Z</div>
            <div class="zzz-symbol text-blue-400 font-bold text-lg absolute top-2 right-2" style="animation-delay: 0.5s">z</div>
            <div class="zzz-symbol text-blue-400 font-bold text-md absolute top-4 right-4" style="animation-delay: 1s">z</div>
        </div>

        <div id="prompt-text" class="font-semibold mb-[20px] mt-[10px] text-center text-[19px] leading-tight tracking-tight transition-colors" style="font-family: 'Montserrat', sans-serif;">
            Prove you're a human. Make Stan smile.
        </div>

        <div id="input-container" class="flex gap-[10px] items-center w-full relative transition-colors duration-1000 p-2 rounded-xl">
            <input id="input-text" type="text" placeholder="Say something nice..." autocomplete="off" class="flex-1 p-[6px_15px] border-[2px] border-[#ddd] rounded-[8px] outline-none transition-colors focus:border-[#3498db]" />
            <div id="captcha-label" class="absolute -bottom-[20px] left-0 text-[10px] opacity-50 transition-colors duration-1000">reReCAPTCHA 4.0</div>
            <button id="submit-btn" class="bg-[#5dade2] text-white p-[6px_20px] rounded-[8px] cursor-pointer font-semibold select-none transition-transform active:scale-95 hover:bg-[#3498db] whitespace-nowrap">Tell Stan</button>
        </div>

    </div>

    <!-- Reset Save Button -->
    <div class="fixed bottom-4 right-4 z-50">
        <button id="reset-save-btn" class="text-xs text-gray-400 hover:text-red-500 bg-white/50 px-2 py-1 rounded">Reset Save</button>
    </div>

    <script>
        const STORAGE_KEY = 'stan_save_v4'; 
        const DAILY_CAP = 40; 
        const HOURLY_MINIGAME_CAP = 15;
        
        let idleTimer = null; // Added timer variable

        // --- BRAIN DATA (Dictionary) ---
        const DICTIONARY = {
            // Insults (-2)
            bald: -2, ugly: -2, bad: -2, stupid: -2, dumb: -2, hate: -2, gross: -2, no: -2, robot: -2, fake: -2, awful: -2, trash: -2, smelly: -2, horrible: -2, crap: -2, idiot: -2, loser: -2,
            // Compliments (+2)
            kind: 2, cool: 2, nice: 2, love: 2, handsome: 2, smart: 2, good: 2, best: 2, great: 2, wow: 2, smile: 2, pretty: 2, beautiful: 2, like: 2, awesome: 2, human: 2, amazing: 2, wonderful: 2, friend: 2, bestie: 2,
            // Task Items (+5 contextually)
            pizza: 0, burger: 0, chocolate: 0, candy: 0, sleep: 0, nap: 0, wake: 0, dance: 0, sing: 0
        };

        const ITEMS = [
            { id: 'hat', name: 'Party Hat', desc: 'Reach 50% Friendship', slot: 'head' },
            { id: 'tophat', name: 'Top Hat', desc: 'Compliment his hair', slot: 'head' },
            { id: 'crown', name: 'Gold Crown', desc: 'Treat Stan like royalty!', slot: 'head' },
            { id: 'ears', name: 'Cat Ears', desc: 'Speak the feline tongue', slot: 'head' },
            { id: 'nose', name: 'Clown Nose', desc: 'Confuse Stan 3 times', slot: 'face' },
            { id: 'monocle', name: 'Monocle', desc: 'Use your vocabulary', slot: 'face' },
            { id: 'bowtie', name: 'Bow Tie', desc: 'Mind your manners', slot: 'neck' },
            { id: 'suit', name: 'Business Suit', desc: 'Ask for a job', slot: 'clothes' },
            { id: 'golden', name: 'Golden Skin', desc: 'Reach 100% Friendship', slot: 'skin' },
            { id: 'matrix', name: 'The Matrix', desc: 'Find the glitch', slot: 'skin' },
        ];

        const TASKS = [
            { text: "I'm hungry...", keywords: ['pizza', 'burger', 'chocolate', 'candy'], reward: 15, type: 'hunger' },
            { text: "I'm bored.", keywords: ['dance', 'sing', 'joke', 'play'], reward: 10, type: 'fun' },
            { text: "I'm tired.", keywords: ['sleep', 'nap', 'bed'], reward: 10, type: 'sleep' },
            { text: "Do I look ok?", keywords: ['yes', 'good', 'handsome', 'cool', 'pretty'], reward: 10, type: 'validate' },
        ];

        const secretWords = {
            'dance': 'dance', 'party': 'dance', 'wiggle': 'dance',
            'cat': 'cat_unlock', 'meow': 'cat_unlock',
            'hack': 'matrix_unlock', 'code': 'matrix_unlock', 'matrix': 'matrix_unlock',
            'invisible': 'invisible', 'ghost': 'invisible',
            'shake': 'shake',
            'flip': 'backflip', 'backflip': 'backflip',
            'king': 'crown_unlock', 'ruler': 'crown_unlock',
            'fancy': 'monocle_unlock', 'classy': 'monocle_unlock',
            'gentleman': 'bowtie_unlock', 'dapper': 'bowtie_unlock',
            'job': 'suit_unlock', 'work': 'suit_unlock', 'business': 'suit_unlock', 'hired': 'suit_unlock',
            'guess': 'game_guess', 'number': 'game_guess',
            'rock': 'game_rps_rock', 'paper': 'game_rps_paper', 'scissors': 'game_rps_scissors', 'play': 'game_rps_rock'
        };

        const defaultState = {
            status: 'idle',
            friendship: 10,
            confusedCount: 0,
            showInventory: false,
            unlocked: { hat: false, tophat: false, crown: false, nose: false, ears: false, monocle: false, bowtie: false, suit: false, matrix: false, golden: false },
            equipped: { hat: false, tophat: false, crown: false, nose: false, ears: false, monocle: false, bowtie: false, suit: false, matrix: false, golden: false },
            effect: '',
            lastLogin: Date.now(),
            dailyPoints: 0,
            dailyDate: new Date().toDateString(),
            currentTask: null,
            isSleeping: false,
            activeMinigame: null, // 'guess', 'rps'
            pendingMinigame: null, // 'guess', 'rps'
            targetNumber: null,
            minigameHistory: { points: 0, lastReset: Date.now() },
            lastInput: ''
        };

        let state = JSON.parse(JSON.stringify(defaultState)); // Deep copy

        const els = {
            body: document.getElementById('body'),
            container: document.getElementById('container'),
            matrixOverlay: document.getElementById('matrix-overlay'),
            particleContainer: document.getElementById('particle-container'),
            stan: document.getElementById('stan'),
            inventoryPanel: document.getElementById('inventory-panel'),
            inventoryGrid: document.getElementById('inventory-grid'),
            friendshipText: document.getElementById('friendship-text'),
            friendshipBar: document.getElementById('friendship-bar'),
            friendshipBg: document.getElementById('friendship-bg'),
            inputContainer: document.getElementById('input-container'),
            captchaLabel: document.getElementById('captcha-label'),
            input: document.getElementById('input-text'),
            submitBtn: document.getElementById('submit-btn'),
            invBtn: document.getElementById('inventory-btn'),
            closeInvBtn: document.getElementById('close-inventory-btn'),
            resetBtn: document.getElementById('reset-save-btn'),
            speechBubble: document.getElementById('speech-bubble'),
            zzz: document.getElementById('zzz-container'),
            prompt: document.getElementById('prompt-text'),
            draggableFood: document.getElementById('draggable-food'),
            // Dev Tool Els
            devToggle: document.getElementById('dev-toggle'),
            devPanel: document.getElementById('dev-panel'),
            devSleep: document.getElementById('dev-sleep'),
            devWake: document.getElementById('dev-wake'),
            devHunger: document.getElementById('dev-hunger'),
            devBored: document.getElementById('dev-bored'),
            devResetDaily: document.getElementById('dev-reset-daily'),
            parts: {
                eyebrowLeft: document.getElementById('eyebrow-left'),
                eyebrowRight: document.getElementById('eyebrow-right'),
                sunglasses: document.getElementById('stan-sunglasses'),
                eyeLeft: document.getElementById('eye-left'),
                eyeRight: document.getElementById('eye-right'),
                mouth: document.getElementById('stan-mouth'),
                tearLeft: document.getElementById('tear-left'),
                tearRight: document.getElementById('tear-right'),
                pupilLeft: document.getElementById('pupil-left'),
                pupilRight: document.getElementById('pupil-right'),
                arm: document.getElementById('stan-arm'),
                handWrapper: document.getElementById('hand-item-wrapper'),
                iconHappy: document.getElementById('icon-happy'),
                iconSad: document.getElementById('icon-sad'),
                iconConfused: document.getElementById('icon-confused'),
                iconRock: document.getElementById('icon-rock'),
                iconPaper: document.getElementById('icon-paper'),
                iconScissors: document.getElementById('icon-scissors'),
                hair: document.getElementById('stan-hair'),
                naturalNose: document.getElementById('stan-nose'),
                accHat: document.getElementById('acc-hat'),
                accTophat: document.getElementById('acc-tophat'),
                accCrown: document.getElementById('acc-crown'),
                accEars: document.getElementById('acc-ears'),
                accNose: document.getElementById('acc-nose'),
                accMonocle: document.getElementById('acc-monocle'),
                accBowtie: document.getElementById('acc-bowtie'),
                accSuit: document.getElementById('acc-suit'),
                accNightcap: document.getElementById('acc-nightcap'),
                pants: document.getElementById('stan-pants'),
                sweat1: document.getElementById('sweat-1'),
                sweat2: document.getElementById('sweat-2'),
            }
        };

        // --- AUDIO SYSTEM (Web Audio API) ---
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioCtx();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type, duration, delay = 0) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration);
        }

        function playHappySound() {
            initAudio();
            playTone(440, 'sine', 0.3, 0); // A4
            playTone(554, 'sine', 0.3, 0.1); // C#5
            playTone(659, 'sine', 0.4, 0.2); // E5
        }

        function playSadSound() {
            initAudio();
            playTone(392, 'triangle', 0.4, 0); // G4
            playTone(370, 'triangle', 0.6, 0.2); // F#4
        }

        function playConfusedSound() {
            initAudio();
            playTone(300, 'square', 0.1, 0);
            playTone(400, 'square', 0.1, 0.1);
        }

        function playUnlockSound() {
            initAudio();
            playTone(523, 'sine', 0.1, 0); // C5
            playTone(659, 'sine', 0.1, 0.1); // E5
            playTone(784, 'sine', 0.1, 0.2); // G5
            playTone(1046, 'sine', 0.4, 0.3); // C6
        }

        function playClickSound() {
            initAudio();
            playTone(800, 'sine', 0.05, 0);
        }

        // --- PARTICLE SYSTEM ---
        function createParticles(type, x, y) {
            const count = 10;
            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.classList.add('particle');
                
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 3;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed - 5; // Upward bias

                el.style.left = x + 'px';
                el.style.top = y + 'px';
                
                if (type === 'heart') {
                    el.innerHTML = '‚ù§Ô∏è';
                    el.style.fontSize = (10 + Math.random() * 10) + 'px';
                } else if (type === 'tear') {
                    el.innerHTML = 'üíß';
                    el.style.fontSize = (10 + Math.random() * 10) + 'px';
                } else if (type === 'confetti') {
                    el.style.width = '8px';
                    el.style.height = '8px';
                    el.style.backgroundColor = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'][Math.floor(Math.random()*5)];
                }

                els.particleContainer.appendChild(el);

                let posX = x;
                let posY = y;
                let opacity = 1;

                const anim = setInterval(() => {
                    posX += vx;
                    posY += vy + 1; // Gravity
                    opacity -= 0.02;
                    el.style.left = posX + 'px';
                    el.style.top = posY + 'px';
                    el.style.opacity = opacity;

                    if (opacity <= 0) {
                        clearInterval(anim);
                        el.remove();
                    }
                }, 16);
            }
        }

        // --- GAME LOGIC ---

        function loadSave() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : null;
            } catch (e) { return null; }
        }

        function saveGame() {
            state.lastLogin = Date.now();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function resetSave() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        function calculateSentiment(text) {
            const words = text.toLowerCase().match(/\b\w+\b/g) || [];
            let score = 0;
            words.forEach(w => {
                if (DICTIONARY[w] !== undefined) score += DICTIONARY[w];
            });
            return score;
        }

        function checkDayNight() {
            const hour = new Date().getHours();
            const isNight = hour >= 20 || hour < 6;
            
            if (isNight) {
                els.body.classList.add('night-bg');
                els.container.classList.add('night-mode'); 
            } else {
                els.body.classList.remove('night-bg');
                els.container.classList.remove('night-mode');
            }
            updateStanVisuals(isNight);
        }

        function checkDecay() {
            const now = Date.now();
            const hoursSince = (now - state.lastLogin) / (1000 * 60 * 60);
            
            // Daily reset for cap
            const today = new Date().toDateString();
            if (state.dailyDate !== today) {
                state.dailyPoints = 0;
                state.dailyDate = today;
            }

            // Sleep Logic
            if (hoursSince > 24) {
                state.isSleeping = true;
            } else {
                state.isSleeping = false;
            }

            // Friendship Decay (5% per hour absent, capped at 20% loss per session)
            if (hoursSince > 1) {
                const loss = Math.min(20, Math.floor(hoursSince * 5));
                if (loss > 0) {
                    state.friendship = Math.max(0, state.friendship - loss);
                }
            }
            saveGame();
        }
        
        function checkMinigameCap() {
            const now = Date.now();
            if (now - state.minigameHistory.lastReset > 3600000) { // 1 hour
                state.minigameHistory.points = 0;
                state.minigameHistory.lastReset = now;
            }
        }
        
        function awardMinigamePoints(amount) {
            checkMinigameCap();
            const available = HOURLY_MINIGAME_CAP - state.minigameHistory.points;
            const toAward = Math.min(amount, available);
            
            if (toAward > 0) {
                state.minigameHistory.points += toAward;
                updateFriendship(toAward, true);
            }
            saveGame();
        }

        function assignTask() {
            if (!state.currentTask && !state.isSleeping && Math.random() < 0.3) {
                state.currentTask = TASKS[Math.floor(Math.random() * TASKS.length)];
                els.speechBubble.innerText = state.currentTask.text;
                els.speechBubble.classList.remove('hidden');
                setState('idle');
            }
        }

        function init() {
            const savedData = loadSave();
            if (savedData) {
                state = { ...defaultState, ...savedData };
                state.unlocked = { ...defaultState.unlocked, ...(savedData.unlocked || {}) };
                state.equipped = { ...defaultState.equipped, ...(savedData.equipped || {}) };
                if(!state.minigameHistory) state.minigameHistory = { points: 0, lastReset: Date.now() };
                
                if (state.currentTask && !state.currentTask.type) {
                    const matched = TASKS.find(t => t.text === state.currentTask.text);
                    if (matched) state.currentTask = matched;
                }
                
                state.friendship = parseInt(state.friendship);
                if(isNaN(state.friendship)) state.friendship = 10;

                state.status = 'idle';
                state.effect = '';
                state.activeMinigame = null;
                state.pendingMinigame = null;
            }
            
            checkDecay();
            checkDayNight();
            setInterval(checkDayNight, 60000);

            renderInventory();
            updateStanVisuals();
            updateFriendship(0);
            assignTask();
            
            els.matrixOverlay.innerHTML = Array(2000).fill(0).map(() => Math.random() > 0.5 ? '1' : '0').join(' ');

            els.submitBtn.addEventListener('click', () => { initAudio(); processInput(); });
            els.input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { initAudio(); processInput(); }
                else { playClickSound(); }
            });
            
            els.invBtn.addEventListener('click', () => {
                initAudio();
                state.showInventory = !state.showInventory;
                updateInventoryPanel();
            });
            els.closeInvBtn.addEventListener('click', () => {
                state.showInventory = false;
                updateInventoryPanel();
            });
            els.resetBtn.addEventListener('click', () => {
                resetSave();
            });

            // DEV TOOL LISTENERS
            els.devToggle.addEventListener('click', () => {
                els.devPanel.classList.toggle('hidden');
            });
            els.devSleep.addEventListener('click', () => {
                state.lastLogin = Date.now() - (25 * 60 * 60 * 1000); 
                checkDecay();
                updateStanVisuals();
            });
            els.devWake.addEventListener('click', () => {
                state.isSleeping = false;
                setState('idle');
                updateStanVisuals();
                saveGame();
            });
            els.devHunger.addEventListener('click', () => {
                state.currentTask = TASKS[0]; 
                els.speechBubble.innerText = state.currentTask.text;
                els.speechBubble.classList.remove('hidden');
                setState('idle');
                updateStanVisuals();
                saveGame();
            });
            els.devBored.addEventListener('click', () => {
                state.currentTask = TASKS[1];
                els.speechBubble.innerText = state.currentTask.text;
                els.speechBubble.classList.remove('hidden');
                setState('idle');
                updateStanVisuals();
                saveGame();
            });
            els.devResetDaily.addEventListener('click', () => {
                state.dailyPoints = 0;
                saveGame();
            });

            // FOOD DRAG LOGIC
            let isDragging = false;
            let startX, startY;
            
            els.draggableFood.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                e.target.style.cursor = 'grabbing';
            });
            
            // Touch events for mobile dragging
            els.draggableFood.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                els.draggableFood.style.transform = `translate(${dx}px, ${dy}px) scale(1.2)`;
            });
            
            window.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;
                els.draggableFood.style.transform = `translate(${dx}px, ${dy}px) scale(1.2)`;
            });

            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);

            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                els.draggableFood.style.cursor = 'grab';
                
                const foodRect = els.draggableFood.getBoundingClientRect();
                const stanRect = els.stan.getBoundingClientRect();

                if (
                    foodRect.left < stanRect.right &&
                    foodRect.right > stanRect.left &&
                    foodRect.top < stanRect.bottom &&
                    foodRect.bottom > stanRect.top
                ) {
                    if (state.currentTask && state.currentTask.type === 'hunger') {
                        completeTask(true);
                    } else {
                        setState('happy');
                        playHappySound();
                        createParticles('heart', stanRect.left + stanRect.width/2, stanRect.top);
                    }
                }
                els.draggableFood.style.transform = 'translate(0, 0) scale(1)';
            }
        }

        function completeTask(viaDrag = false) {
            setState('happy');
            updateFriendship(state.currentTask.reward, true); 
            els.speechBubble.classList.add('hidden');
            state.currentTask = null;
            const rect = els.stan.getBoundingClientRect();
            createParticles('heart', rect.left + rect.width/2, rect.top + rect.height/2);
            playHappySound();
            if (!viaDrag) els.input.value = '';
            updateStanVisuals();
            saveGame();
        }

        function playRPS(playerChoice) {
            els.parts.arm.classList.add('animate-rps');
            els.speechBubble.innerText = "Rock... Paper...";
            els.speechBubble.classList.remove('hidden');

            setTimeout(() => {
                els.parts.arm.classList.remove('animate-rps');
                const choices = ['rock', 'paper', 'scissors'];
                const stanChoice = choices[Math.floor(Math.random() * 3)];
                
                els.parts.iconRock.classList.add('hidden');
                els.parts.iconPaper.classList.add('hidden');
                els.parts.iconScissors.classList.add('hidden');
                
                els.parts.arm.classList.add('rotate-[-140deg]');
                els.parts.handWrapper.classList.add('scale-100', 'opacity-100', 'rotate-[140deg]');

                if (stanChoice === 'rock') els.parts.iconRock.classList.remove('hidden');
                else if (stanChoice === 'paper') els.parts.iconPaper.classList.remove('hidden');
                else els.parts.iconScissors.classList.remove('hidden');

                let result = '';
                if (playerChoice === stanChoice) result = "Tie!";
                else if (
                    (playerChoice === 'rock' && stanChoice === 'scissors') ||
                    (playerChoice === 'paper' && stanChoice === 'rock') ||
                    (playerChoice === 'scissors' && stanChoice === 'paper')
                ) {
                    result = "You Win!";
                    awardMinigamePoints(15);
                    createParticles('confetti', window.innerWidth/2, window.innerHeight/2);
                    playHappySound();
                    setState('happy');
                } else {
                    result = "I Win!";
                    playSadSound();
                    setState('happy');
                }
                els.speechBubble.innerText = `${stanChoice.toUpperCase()}! ${result}`;
                setTimeout(() => {
                    state.activeMinigame = null;
                    setState('idle');
                    updateStanVisuals();
                }, 3000);
            }, 1500);
        }

        function playGuessNumber(input) {
            const guess = parseInt(input);
            if (isNaN(guess)) return;

            if (guess === state.targetNumber) {
                els.speechBubble.innerText = "Correct! You win!";
                awardMinigamePoints(10);
                playHappySound();
                setState('happy');
                setTimeout(() => {
                    state.activeMinigame = null;
                    state.targetNumber = null;
                    setState('idle');
                    els.speechBubble.classList.add('hidden');
                }, 2000);
            } else if (guess < state.targetNumber) {
                els.speechBubble.innerText = "Higher!";
                setState('confused');
            } else {
                els.speechBubble.innerText = "Lower!";
                setState('confused');
            }
        }

        function processInput() {
            const text = els.input.value.toLowerCase().trim();
            if (!text) return;
            
            // Mobile Optimization: Close keyboard
            if (window.innerWidth < 600) els.input.blur();

            // Spam Protection
            if (text === state.lastInput && !state.activeMinigame) {
                // Special case: Don't change status to confused if spamming, just show bubble
                // forcing update without changing main state to keep previous emotion or just flicker
                els.speechBubble.innerText = "You just said that...";
                els.speechBubble.classList.remove('hidden');
                setTimeout(() => els.speechBubble.classList.add('hidden'), 1500);
                return;
            }
            state.lastInput = text;

            const rect = els.stan.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            if (state.isSleeping) {
                if (text.includes('wake')) {
                    state.isSleeping = false;
                    setState('confused');
                    els.speechBubble.innerText = "Huh? I'm up!";
                    els.speechBubble.classList.remove('hidden');
                    setTimeout(() => els.speechBubble.classList.add('hidden'), 2000);
                    updateStanVisuals();
                }
                els.input.value = '';
                return;
            }

            if (state.pendingMinigame) {
                 if (['yes', 'sure', 'ok', 'yeah'].some(w => text.includes(w))) {
                     state.activeMinigame = state.pendingMinigame;
                     state.pendingMinigame = null;
                     
                     if (state.activeMinigame === 'guess') {
                         state.targetNumber = Math.floor(Math.random() * 10) + 1;
                         els.speechBubble.innerText = "I'm thinking of a number (1-10).";
                         els.speechBubble.classList.remove('hidden');
                     } else if (state.activeMinigame === 'rps') {
                         els.speechBubble.innerText = "Okay! Type rock, paper, or scissors!";
                         els.speechBubble.classList.remove('hidden');
                     }
                 } else {
                     state.pendingMinigame = null;
                     els.speechBubble.innerText = "Maybe later.";
                     setTimeout(() => els.speechBubble.classList.add('hidden'), 2000);
                 }
                 els.input.value = '';
                 return;
            }

            if (state.activeMinigame === 'guess') {
                playGuessNumber(text);
                els.input.value = '';
                return;
            }
            if (state.activeMinigame === 'rps') {
                 if (['rock', 'paper', 'scissors'].includes(text)) {
                     playRPS(text);
                 } else {
                     els.speechBubble.innerText = "Type rock, paper, or scissors!";
                 }
                 els.input.value = '';
                 return;
            }

            let foundAction = null;
            for (const [key, action] of Object.entries(secretWords)) {
                if (text.includes(key)) {
                    foundAction = action;
                    break;
                }
            }

            if (foundAction) {
                if (foundAction.startsWith('game_')) {
                    if (foundAction.includes('rps')) {
                        state.pendingMinigame = 'rps';
                        els.speechBubble.innerText = "Play Rock Paper Scissors?";
                    } else if (foundAction.includes('guess')) {
                        state.pendingMinigame = 'guess';
                        els.speechBubble.innerText = "Play Guess the Number?";
                    }
                    els.speechBubble.classList.remove('hidden');
                    setState('confused');
                } else if (foundAction === 'matrix_unlock') {
                    unlockItem('matrix');
                } else if (foundAction === 'cat_unlock') {
                    unlockItem('ears');
                    setState('happy');
                } else if (foundAction === 'crown_unlock') {
                    unlockItem('crown');
                    setState('happy');
                } else if (foundAction === 'monocle_unlock') {
                    unlockItem('monocle');
                    setState('happy');
                } else if (foundAction === 'bowtie_unlock') {
                    unlockItem('bowtie');
                    setState('happy');
                } else if (foundAction === 'suit_unlock') {
                    unlockItem('suit');
                    setState('happy');
                } else {
                    setEffect(foundAction);
                    setTimeout(() => setEffect(''), 2000);
                }
                els.input.value = '';
                return;
            }

            if (text.split(' ').some(w => w.length >= 10)) unlockItem('monocle');
            if (text.includes('please') || text.includes('thank')) unlockItem('bowtie');

            if (state.currentTask) {
                const completed = state.currentTask.keywords.some(k => text.includes(k));
                if (completed) {
                    completeTask();
                    return;
                }
            }

            if (text.includes('hair') && calculateSentiment(text) > 0) {
                setState('happy');
                updateFriendship(10);
                unlockItem('tophat');
                playHappySound();
                els.input.value = '';
                return;
            }

            const score = calculateSentiment(text);

            if (score < 0) {
                setState('sad');
                updateFriendship(-5);
                createParticles('tear', centerX, centerY);
                playSadSound();
            } else if (score > 0) {
                setState('happy');
                updateFriendship(5);
                createParticles('heart', centerX, centerY);
                playHappySound();
            } else {
                setState('confused');
                state.confusedCount++;
                playConfusedSound();
                if (state.confusedCount >= 3) unlockItem('nose');
            }

            saveGame();
            els.input.value = '';
        }

        function setState(newStatus) {
            state.status = newStatus;
            updateStanVisuals();

            // Auto-hide arm and icons after 3 seconds
            if (idleTimer) clearTimeout(idleTimer);
            
            if (newStatus !== 'idle') {
                idleTimer = setTimeout(() => {
                    state.status = 'idle';
                    // Clean up potential lingering game states if they rely on status
                    if (state.activeMinigame === 'guess') {
                        state.activeMinigame = null;
                        state.targetNumber = null;
                        els.speechBubble.classList.add('hidden');
                    }
                    updateStanVisuals();
                }, 3000);
            }
        }

        function setEffect(eff) {
            state.effect = eff;
            updateStanVisuals();
        }

        function updateFriendship(amount, bypassCap = false) {
            if (amount > 0 && !bypassCap) {
                if (state.dailyPoints >= DAILY_CAP) {
                    els.prompt.innerText = "Stan is overwhelmed with compliments today.";
                    return; 
                }
                state.dailyPoints += amount;
            } else {
                els.prompt.innerText = "Prove you're a human. Make Stan smile.";
            }

            let current = parseInt(state.friendship);
            if(isNaN(current)) current = 10;

            let newVal = Math.max(0, Math.min(100, current + amount));
            if (newVal >= 50 && current < 50) unlockItem('hat');
            if (newVal >= 100 && current < 100) unlockItem('golden');
            state.friendship = newVal;
            
            els.friendshipText.innerText = state.friendship + '%';
            els.friendshipBar.style.width = state.friendship + '%';
            
            let color = '#2ecc71';
            if (state.equipped.matrix) color = '#00ff00';
            else if (state.friendship < 30) color = '#e74c3c';
            else if (state.friendship < 70) color = '#f1c40f';
            
            els.friendshipBar.style.backgroundColor = color;
            els.friendshipBg.className = `w-full h-3 rounded-full overflow-hidden ${state.equipped.matrix ? 'bg-[#003300]' : 'bg-gray-200'}`;
            saveGame();
        }

        function unlockItem(itemId) {
            if (!state.unlocked[itemId]) {
                state.unlocked[itemId] = true;
                playUnlockSound();
                const rect = els.container.getBoundingClientRect();
                createParticles('confetti', rect.left + 225, rect.top + 100);
                renderInventory();
                saveGame();
            }
        }

        function toggleEquip(itemId) {
            if (!state.unlocked[itemId]) return;
            const itemMeta = ITEMS.find(i => i.id === itemId);
            if (state.equipped[itemId]) {
                state.equipped[itemId] = false;
            } else {
                ITEMS.filter(i => i.slot === itemMeta.slot).forEach(i => {
                    state.equipped[i.id] = false;
                });
                state.equipped[itemId] = true;
            }
            saveGame();
            renderInventory();
            updateStanVisuals();
        }

        function updateInventoryPanel() {
            if (state.showInventory) {
                els.inventoryPanel.classList.remove('translate-y-full', 'opacity-0', 'pointer-events-none');
                els.inventoryPanel.classList.add('translate-y-0', 'opacity-100', 'pointer-events-auto');
            } else {
                els.inventoryPanel.classList.remove('translate-y-0', 'opacity-100', 'pointer-events-auto');
                els.inventoryPanel.classList.add('translate-y-full', 'opacity-0', 'pointer-events-none');
            }
        }

        function renderInventory() {
            els.inventoryGrid.innerHTML = '';
            ITEMS.forEach(item => {
                const isUnlocked = state.unlocked[item.id];
                const isEquipped = state.equipped[item.id];
                const card = document.createElement('div');
                let classes = 'item-card p-3 rounded-xl border-2 cursor-pointer flex flex-col items-center text-center relative ';
                if (!isUnlocked) classes += 'locked bg-gray-50 border-gray-100';
                else if (isEquipped) classes += 'bg-blue-50 border-blue-400 ring-1 ring-blue-400';
                else classes += 'bg-white border-gray-200 hover:border-blue-200';
                card.className = classes;
                card.onclick = () => toggleEquip(item.id);

                let iconHtml = '';
                switch(item.id) {
                    case 'hat': iconHtml = '<div class="w-8 h-8 relative"><div class="w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[25px] border-b-[#3498db] mx-auto"></div></div>'; break;
                    case 'tophat': iconHtml = '<div class="w-8 h-8 relative flex flex-col items-center justify-end"><div class="w-6 h-6 bg-black"></div><div class="w-10 h-1 bg-black"></div></div>'; break;
                    case 'crown': iconHtml = '<div class="w-8 h-6 bg-yellow-400 relative mx-auto mt-2"><div class="absolute -top-2 left-0 w-2 h-2 bg-yellow-400 rotate-45"></div><div class="absolute -top-2 left-3 w-2 h-2 bg-yellow-400 rotate-45"></div><div class="absolute -top-2 right-0 w-2 h-2 bg-yellow-400 rotate-45"></div></div>'; break;
                    case 'nose': iconHtml = '<div class="w-4 h-4 bg-red-500 rounded-full mx-auto mt-2 border border-red-700"></div>'; break;
                    case 'monocle': iconHtml = '<div class="w-6 h-6 rounded-full border-2 border-yellow-600 mx-auto mt-1 relative"><div class="absolute top-0 right-[-5px] w-2 h-[2px] bg-yellow-600 rotate-45"></div></div>'; break;
                    case 'ears': iconHtml = '<div class="flex justify-center gap-1 mt-2"><div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[12px] border-b-[#333]"></div><div class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[12px] border-b-[#333]"></div></div>'; break;
                    case 'bowtie': iconHtml = '<div class="flex justify-center items-center mt-2"><div class="w-0 h-0 border-t-[5px] border-t-transparent border-l-[8px] border-l-red-600 border-b-[5px] border-b-transparent"></div><div class="w-2 h-2 bg-red-600 rounded-full -mx-1 relative z-10"></div><div class="w-0 h-0 border-t-[5px] border-t-transparent border-r-[8px] border-r-red-600 border-b-[5px] border-b-transparent"></div></div>'; break;
                    case 'suit': iconHtml = '<div class="w-8 h-8 relative flex items-center justify-center"><div class="w-0 h-0 border-l-[8px] border-r-[8px] border-t-[14px] border-l-transparent border-r-transparent border-t-black absolute top-2"></div><div class="w-[2px] h-[10px] bg-red-600 absolute top-2"></div></div>'; break;
                    case 'golden': iconHtml = '<div class="w-6 h-6 rounded-full bg-gradient-to-br from-[#ffd700] to-[#f1c40f] mx-auto mt-1 border-2 border-white shadow-sm"></div>'; break;
                    case 'matrix': iconHtml = '<div class="text-[10px] font-mono leading-none text-center mt-1 font-bold text-green-600">101<br/>010</div>'; break;
                }

                let lockOverlay = '';
                if (!isUnlocked) {
                    lockOverlay = `<div class="absolute inset-0 flex items-center justify-center z-10 text-gray-400 padlock-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg></div>`;
                }

                card.innerHTML = `${lockOverlay}<div class="h-10 w-full flex items-center justify-center icon mb-1">${iconHtml}</div><div class="text-sm font-bold leading-tight">${item.name}</div><div class="text-[10px] text-gray-500 mt-1 leading-tight">${item.desc}</div>`;
                els.inventoryGrid.appendChild(card);
            });
        }

        function updateStanVisuals(isNightForce) {
            const s = state.status;
            const eq = state.equipped;
            const eff = state.effect;
            
            const hour = new Date().getHours();
            const isNight = isNightForce !== undefined ? isNightForce : (hour >= 20 || hour < 6);

            const showNightcap = isNight && !eq.hat && !eq.tophat && !eq.crown && !eq.ears;
            if(showNightcap) {
                els.parts.accNightcap.classList.remove('hidden');
                els.parts.hair.classList.add('hidden'); 
            } else {
                els.parts.accNightcap.classList.add('hidden');
            }
            
            if(state.isSleeping) {
                els.zzz.classList.remove('hidden');
                els.stan.classList.add('sleeping-pose');
                els.parts.eyeLeft.classList.add('hidden');
                els.parts.eyeRight.classList.add('hidden');
                els.speechBubble.classList.add('hidden');
                els.parts.arm.classList.add('hidden');
            } else {
                els.zzz.classList.add('hidden');
                els.stan.classList.remove('sleeping-pose');
                els.parts.eyeLeft.classList.remove('hidden');
                els.parts.eyeRight.classList.remove('hidden');
                if(state.currentTask || state.activeMinigame || state.pendingMinigame) {
                    els.speechBubble.classList.remove('hidden');
                } else {
                    els.speechBubble.classList.add('hidden');
                }
                // Arm visibility handled below
            }

            if (!state.isSleeping && state.currentTask && state.currentTask.type === 'hunger') {
                els.draggableFood.classList.remove('hidden');
            } else {
                els.draggableFood.classList.add('hidden');
            }

            if (eq.matrix) {
                els.container.classList.add('matrix-mode');
                els.container.classList.remove('bg-white');
                els.body.classList.add('bg-black');
                els.body.classList.remove('bg-[#f0f2f5]');
                els.matrixOverlay.classList.remove('hidden');
                els.invBtn.classList.add('bg-[#003300]', 'text-green-400');
                els.invBtn.classList.remove('bg-gray-100', 'text-gray-600');
            } else {
                els.container.classList.remove('matrix-mode');
                if(isNight) {
                    els.container.classList.remove('bg-white');
                } else {
                    els.container.classList.add('bg-white');
                }
                els.body.classList.remove('bg-black');
                els.matrixOverlay.classList.add('hidden');
                els.invBtn.classList.remove('bg-[#003300]', 'text-green-400');
                els.invBtn.classList.add('bg-gray-100', 'text-gray-600');
            }

            if (eq.golden) els.stan.classList.add('golden-skin');
            else els.stan.classList.remove('golden-skin');

            els.stan.classList.remove('animate-dance', 'animate-shake', 'opacity-20', 'animate-backflip');

            if (eff === 'dance') els.stan.classList.add('animate-dance');
            if (eff === 'shake') els.stan.classList.add('animate-shake');
            if (eff === 'invisible') els.stan.classList.add('opacity-20');
            if (eff === 'backflip') els.stan.classList.add('animate-backflip');

            if (eq.hat) els.parts.accHat.classList.remove('hidden'); else els.parts.accHat.classList.add('hidden');
            if (eq.tophat) els.parts.accTophat.classList.remove('hidden'); else els.parts.accTophat.classList.add('hidden');
            if (eq.crown) els.parts.accCrown.classList.remove('hidden'); else els.parts.accCrown.classList.add('hidden');
            if (eq.ears) els.parts.accEars.classList.remove('hidden'); else els.parts.accEars.classList.add('hidden');
            if (eq.nose) els.parts.accNose.classList.remove('hidden'); else els.parts.accNose.classList.add('hidden');
            if (eq.monocle) els.parts.accMonocle.classList.remove('hidden'); else els.parts.accMonocle.classList.add('hidden');
            if (eq.bowtie) els.parts.accBowtie.classList.remove('hidden'); else els.parts.accBowtie.classList.add('hidden');
            if (eq.suit) {
                els.parts.accSuit.classList.remove('hidden');
                els.parts.pants.classList.remove('bg-[#2980b9]');
                els.parts.pants.classList.add('bg-black');
            } else {
                els.parts.accSuit.classList.add('hidden');
                els.parts.pants.classList.add('bg-[#2980b9]');
                els.parts.pants.classList.remove('bg-black');
            }

            if (eq.hat || eq.crown || eq.tophat || showNightcap) els.parts.hair.classList.add('hidden'); 
            else els.parts.hair.classList.remove('hidden');

            if (eq.nose) els.parts.naturalNose.classList.add('hidden'); else els.parts.naturalNose.classList.remove('hidden');
            
            if (eq.monocle) els.parts.sunglasses.classList.add('hidden'); else els.parts.sunglasses.classList.remove('hidden');

            els.parts.eyebrowLeft.className = `absolute top-[28px] left-[36px] w-[25px] h-[5px] bg-[#333] z-[4] rounded-full transition-transform duration-300 ${s === 'happy' ? '-translate-y-1 rotate-[-5deg]' : s === 'sad' ? 'rotate-[-15deg] translate-y-1' : s === 'confused' ? '-translate-y-2 rotate-[-20deg]' : ''}`;
            els.parts.eyebrowRight.className = `absolute top-[28px] right-[36px] w-[25px] h-[5px] bg-[#333] z-[4] rounded-full transition-transform duration-300 ${s === 'happy' ? '-translate-y-1 rotate-[5deg]' : s === 'sad' ? 'rotate-[15deg] translate-y-1' : s === 'confused' ? 'translate-y-0 rotate-[0deg]' : ''}`;

            els.parts.mouth.className = `absolute left-1/2 -translate-x-1/2 transition-all duration-300 z-[3] ${s === 'happy' ? 'w-[30px] h-[20px] bg-transparent border-b-[4px] border-[#333] rounded-b-full bottom-[13px]' : s === 'sad' ? 'w-[30px] h-[20px] bg-transparent border-t-[4px] border-[#333] rounded-t-full bottom-[4px]' : s === 'confused' ? 'w-[20px] h-[4px] bg-[#333] rounded-[2px] bottom-[16px] -rotate-6' : 'w-[30px] h-[4px] bg-[#333] rounded-[2px] bottom-[16px]'}`;

            if (s === 'sad') {
                els.parts.tearLeft.classList.remove('h-0', 'opacity-0'); els.parts.tearLeft.classList.add('h-[40px]', 'opacity-100');
                els.parts.tearRight.classList.remove('h-0', 'opacity-0'); els.parts.tearRight.classList.add('h-[40px]', 'opacity-100');
                els.parts.pupilLeft.classList.add('translate-y-[2px]'); els.parts.pupilRight.classList.add('translate-y-[2px]');
            } else {
                els.parts.tearLeft.classList.add('h-0', 'opacity-0'); els.parts.tearLeft.classList.remove('h-[40px]', 'opacity-100');
                els.parts.tearRight.classList.add('h-0', 'opacity-0'); els.parts.tearRight.classList.remove('h-[40px]', 'opacity-100');
                els.parts.pupilLeft.classList.remove('translate-y-[2px]'); els.parts.pupilRight.classList.remove('translate-y-[2px]');
                if (s === 'happy') {
                    els.parts.pupilLeft.classList.add('translate-y-[-2px]'); els.parts.pupilRight.classList.add('translate-y-[-2px]');
                } else {
                    els.parts.pupilLeft.classList.remove('translate-y-[-2px]'); els.parts.pupilRight.classList.remove('translate-y-[-2px]');
                }
            }

            if (!state.isSleeping) {
                // Allow standard arm logic if NO minigame OR if minigame is 'guess' (which uses standard emotions)
                // RPS has its own custom animation loop, so we ignore it here
                const useStandardArm = !state.activeMinigame || state.activeMinigame === 'guess';
                
                if (s === 'idle' && useStandardArm) {
                    els.parts.arm.classList.add('opacity-0', 'rotate-0');
                    els.parts.arm.classList.remove('opacity-100', 'rotate-[-140deg]', 'rotate-[-20deg]');
                    els.parts.handWrapper.classList.add('opacity-0', 'scale-0');
                    els.parts.handWrapper.classList.remove('opacity-100', 'scale-100', 'rotate-[140deg]', 'rotate-[20deg]');
                } else if (useStandardArm) {
                    els.parts.arm.classList.remove('opacity-0', 'rotate-0');
                    els.parts.arm.classList.add('opacity-100');
                    els.parts.handWrapper.classList.remove('opacity-0', 'scale-0');
                    els.parts.handWrapper.classList.add('opacity-100', 'scale-100');

                    if (s === 'happy' || s === 'confused') {
                        els.parts.arm.classList.add('rotate-[-140deg]'); els.parts.arm.classList.remove('rotate-[-20deg]');
                        els.parts.handWrapper.classList.add('rotate-[140deg]'); els.parts.handWrapper.classList.remove('rotate-[20deg]');
                    } else if (s === 'sad') {
                        els.parts.arm.classList.add('rotate-[-20deg]'); els.parts.arm.classList.remove('rotate-[-140deg]');
                        els.parts.handWrapper.classList.add('rotate-[20deg]'); els.parts.handWrapper.classList.remove('rotate-[140deg]');
                    }
                }
            }

            els.parts.iconHappy.classList.add('hidden');
            els.parts.iconSad.classList.add('hidden');
            els.parts.iconConfused.classList.add('hidden');
            
            // Allow icons if not RPS (RPS handles its own icons)
            if (state.activeMinigame !== 'rps') {
                els.parts.iconRock.classList.add('hidden');
                els.parts.iconPaper.classList.add('hidden');
                els.parts.iconScissors.classList.add('hidden');
                if (s === 'happy') els.parts.iconHappy.classList.remove('hidden');
                if (s === 'sad') els.parts.iconSad.classList.remove('hidden');
                if (s === 'confused') els.parts.iconConfused.classList.remove('hidden');
            }
        }

        init();
    </script>
</body>
</html>
